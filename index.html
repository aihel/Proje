<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flappy Bird Math Edition</title>
<style>
body{
    margin:0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    color:white;
    font-family:Arial;
    user-select:none;
}
canvas{
    border-radius:15px;
    box-shadow:0 0 25px rgba(255,255,255,0.15);
}
#questionBox{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    display:none;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    gap:20px;
    text-align:center;
    color:white;
    font-size:1.3em;
}
button.option{
    padding:10px 25px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    display:block;
    margin:5px 0;
    width:220px;
    font-size:1.2em;
}
</style>
</head>
<body>
<canvas id="canvas" width="500" height="700"></canvas>
<div id="questionBox">
    <h2 id="questionText"></h2>
    <div id="options"></div>
    <p id="solution"></p>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

/* =============== IMAGES =============== */
function load(name){ const img=new Image(); img.src="sprites/"+name; return img; }
const bg = load("background-day.png");
const baseImg = load("base.png");
const pipeImg = load("pipe-green.png");
const birdFrames = [load("yellowbird-upflap.png"),load("yellowbird-midflap.png"),load("yellowbird-downflap.png")];
const messageImg = load("message.png");
const gameoverImg = load("gameover.png");

const scoreSprites = {"0":load("00000.png"),"1":load("111.png"),"2":load("99999.png"),"3":load("33.png"),"4":load("44.png"),"5":load("55.png"),"6":load("66.png"),"7":load("77.png"),"8":load("88.png"),"9":load("99.png")};

/* =============== QUESTIONS =============== */
const questions=[];
for(let i=1;i<=90;i++){
    let a=Math.floor(Math.random()*8)+2;
    let b=Math.floor(Math.random()*9)+1;
    questions.push({
        q:`${a} işçi bir işi ${b*2} günde yapıyor. İşçi sayısı ${a*2} olursa kaç günde biter?`,
        ans:b.toString(),
        sol:`İşçi sayısı artarsa süre azalır (ters orantı). Cevap: ${b}`
    });
}
let askedQuestions=new Set();
let currentQuestion=null;
let awaitingQuestion=false;

/* =============== GAME VARIABLES =============== */
let bird={x:100,y:300,vy:0,frame:0};
let pipes=[];
let state="menu";
let score=0;
const bgm = new Audio("88.m4a"); bgm.loop=true;
let pipeInterval = null;

/* =============== INPUT =============== */
canvas.addEventListener("click",()=>{
    if(state==="menu"){
        resetGame(); 
        state="play"; 
        bird.vy=-6; 
        bgm.play(); 
        startPipeSpawning();
        return;
    }
    if(state==="play"){ bird.vy=-6; }
});

/* =============== FUNCTIONS =============== */
function resetGame(){ 
    pipes=[]; 
    bird.y=300; 
    bird.vy=0; 
    score=0; 
    stopPipeSpawning();
}

function startPipeSpawning() {
    if (pipeInterval) clearInterval(pipeInterval);
    pipeInterval = setInterval(() => {
        if(state === "play") {
            let top = Math.random() * 250 + 50;
            pipes.push({x:canvas.width, top:top, passed:false});
        }
    }, 2000);
}

function stopPipeSpawning() {
    if (pipeInterval) {
        clearInterval(pipeInterval);
        pipeInterval = null;
    }
}

function askQuestion(){
    if(awaitingQuestion) return;
    awaitingQuestion=true;
    stopPipeSpawning();
    
    let available=questions.filter((q,i)=>!askedQuestions.has(i));
    if(available.length===0){ 
        state="menu"; 
        awaitingQuestion=false; 
        return; 
    }
    let index=Math.floor(Math.random()*available.length);
    currentQuestion=available[index];
    askedQuestions.add(questions.indexOf(currentQuestion));

    document.getElementById("questionText").innerText=currentQuestion.q;
    const opts=document.getElementById("options");
    opts.innerHTML="";
    const correct=parseInt(currentQuestion.ans);
    let choices=[correct-1,correct,correct+1,correct+2].map(String);
    for(let c of choices){
        let btn=document.createElement("button");
        btn.className="option"; 
        btn.innerText=c;
        btn.onclick=()=>checkAnswerBtn(c);
        opts.appendChild(btn);
    }
    document.getElementById("solution").innerText="";
    document.getElementById("questionBox").style.display="flex";
}

function checkAnswerBtn(val){
    if(val==currentQuestion.ans){
        document.getElementById("questionBox").style.display="none";
        resetGame(); 
        state="menu"; 
        awaitingQuestion=false;
    }else{
        document.getElementById("solution").innerText="Yanlış! "+currentQuestion.sol;
    }
}

/* =============== UPDATE =============== */
function update(){
    if(state!=="play") return;
    
    bird.vy+=0.35; 
    bird.y+=bird.vy; 
    bird.frame+=0.2;

    // Bird sınırları
    if(bird.y > canvas.height - 50) {
        bird.y = canvas.height - 50;
        bird.vy = 0;
    }
    if(bird.y < 0) {
        bird.y = 0;
        bird.vy = 0;
    }

    // Pipe'ları güncelle
    for(let i = pipes.length - 1; i >= 0; i--) {
        let p = pipes[i];
        p.x -= 4; 

        // Çarpışma kontrolü
        const birdWidth = 50;
        const birdHeight = 40;
        const pipeWidth = 60;
        const pipeGap = 140;
        
        // Üst boru çarpışması
        const hitTop = bird.x + birdWidth > p.x && 
                      bird.x < p.x + pipeWidth && 
                      bird.y < p.top;
        
        // Alt boru çarpışması
        const hitBottom = bird.x + birdWidth > p.x && 
                         bird.x < p.x + pipeWidth && 
                         bird.y + birdHeight > p.top + pipeGap;

        if(hitTop || hitBottom) { 
            state = "gameover"; 
            stopPipeSpawning();
            setTimeout(() => askQuestion(), 500); 
            return;
        }

        // Skor kontrolü
        if(!p.passed && p.x + pipeWidth < bird.x) { 
            score++; 
            p.passed = true; 
        }

        // Pipe'ı kaldır
        if(p.x + pipeWidth < 0) { 
            pipes.splice(i, 1); 
        }
    }
}

/* =============== DRAW =============== */
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(bg,0,0,canvas.width,canvas.height);

    pipes.forEach(p=>{
        // Üst boru
        ctx.save();
        ctx.translate(p.x + 30, p.top);
        ctx.scale(1, 1);
        ctx.drawImage(pipeImg, -30, -320, 60, 320);
        ctx.restore();

        // Alt boru (ters çizilmiş)
        ctx.save();
        ctx.translate(p.x + 30, p.top + 140);
        ctx.scale(1, -1);
        ctx.drawImage(pipeImg, -30, -320, 60, 320);
        ctx.restore();
    });

    if(state !== "menu" && state !== "gameover"){
        ctx.drawImage(birdFrames[Math.floor(bird.frame) % 3], bird.x, bird.y, 50, 40);
    }

    ctx.drawImage(baseImg, 0, canvas.height - 50, canvas.width, 50);

    if(state === "menu") { 
        ctx.drawImage(messageImg, canvas.width/2 - 110, canvas.height/2 - 60, 220, 120); 
    }
    if(state === "gameover") { 
        ctx.drawImage(gameoverImg, canvas.width/2 - 120, canvas.height/2 - 60, 240, 120); 
    }

    // Score
    let s = score.toString(); 
    let offset = 0;
    for(let i = 0; i < s.length; i++){
        let digit = s[i];
        if(scoreSprites[digit]){
            ctx.drawImage(scoreSprites[digit], canvas.width/2 - ((s.length * 30) / 2) + offset, 20, 30, 50);
        }
        offset += 30;
    }
}

/* =============== LOOP =============== */
function loop(){ 
    update(); 
    draw(); 
    requestAnimationFrame(loop); 
}

// Başlangıçta pipe spawn'ı kapalı
stopPipeSpawning();
loop();
</script>
</body>
</html>
